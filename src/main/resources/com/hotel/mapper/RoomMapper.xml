<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hotel.mapper.RoomMapper">

	<!-- 객실 상세페이지 -->
	<select id="getRoomById" resultType="com.hotel.domain.RoomVO">
		SELECT
		ri_id AS riId,
		ri_type
		AS riType,
		ri_name AS riName,
		ri_desc AS riDesc,
		ri_person AS riPerson,
		ri_maxperson AS riMaxperson,
		ri_area AS riArea,
		ri_bed AS riBed,
		ri_bedcnt AS riBedcnt,
		ri_price AS
		riPrice,
		ri_bedroom AS riBedroom,
		ri_bathroom AS
		riBathroom
		FROM t_room_info
		WHERE si_id = #{siId} AND
		ri_id = #{riId}
	</select>

	<!-- 객실 편의시설 목록 조회 -->
	<select id="getFacilitiesByRoomId"
		resultType="com.hotel.domain.FacilityVO">
		SELECT
		f.fi_id AS fiId,
		f.fi_name AS fiName,
		f.fi_icon AS
		fiIcon
		FROM t_facility_info f
		JOIN t_room_facility_rel rfr ON f.fi_id =
		rfr.fi_id
		WHERE rfr.ri_id = #{riId}
		AND rfr.si_id = #{siId}
	</select>

	<!-- 객실 어메니티 목록 조회 -->
	<select id="getAmenitiesByRoomId"
		resultType="com.hotel.domain.AmenityVO">
		SELECT
		a.ai_idx AS aiIdx,
		a.ra_name AS raName
		FROM
		t_amenities_info a
		JOIN
		t_room_amenities ra ON a.ai_idx = ra.ai_idx
		WHERE
		ra.si_id = #{siId}
		AND
		ra.ri_id = #{riId}
	</select>

	<!-- 상세페이지 객실 제외 나머지 객실 목록 조회 -->
	<select id="getOtherRoomsByStayId"
		resultType="com.hotel.domain.RoomVO">
		SELECT
		ri_id AS riId,
		ri_type AS riType,
		ri_name AS riName,
		ri_desc AS riDesc,
		ri_person AS riPerson,
		ri_maxperson AS riMaxperson,
		ri_area AS riArea,
		ri_bed AS riBed,
		ri_bedcnt AS riBedcnt,
		ri_price AS
		riPrice,
		ri_bedroom AS riBedroom,
		ri_bathroom AS
		riBathroom
		FROM
		t_room_info
		WHERE si_id = #{siId}
		AND ri_id != #{riId}
	</select>

	<!-- 어메니티 목록 조회 -->
	<select id="getAllAmenities"
		resultType="com.hotel.domain.AmenityVO">
		SELECT ai_idx AS aiIdx, ra_name AS raName FROM
		t_amenities_info ORDER BY ai_idx
	</select>

	<!-- admin 객실 등록 -->
	<insert id="insertRoom" parameterType="com.hotel.domain.RoomVO">
		<!-- siId에서 riId 최대값+1 조회 -->
		<selectKey keyProperty="riId" resultType="int"
			order="BEFORE">
			SELECT NVL(MAX(ri_id), 0) + 1
			FROM t_room_info
			WHERE si_id = #{siId}
		</selectKey>
		
		INSERT INTO t_room_info (
		si_id, ri_id, ri_type, ri_name, ri_desc,
		ri_person,
		ri_maxperson,
		ri_area, ri_bed, ri_bedcnt,
		ri_price,
		ri_bedroom,
		ri_bathroom, ri_show,
		ri_delete, ri_date
		) VALUES (
		#{siId},
		#{riId}, #{riType},
		#{riName}, #{riDesc},
		#{riPerson},
		#{riMaxperson}, #{riArea}, #{riBed},
		#{riBedcnt},
		#{riPrice},
		#{riBedroom}, #{riBathroom}, #{riShow},
		#{riDelete},
		SYSDATE
		)
	</insert>

	<insert id="insertRoomFacility">
		INSERT INTO t_room_facility_rel (si_id, ri_id, fi_id)
		VALUES (#{siId}, #{riId}, #{fiId})
	</insert>

	<insert id="insertRoomAmenity">
		INSERT INTO t_room_amenities (si_id, ri_id, ai_idx)
		VALUES (#{siId}, #{riId}, #{aiIdx, jdbcType=INTEGER})
	</insert>

	<insert id="insertRoomPhoto"
		parameterType="com.hotel.domain.RoomPhotoVO">
		INSERT INTO t_room_photo (si_id, ri_id, sp_idx, sp_url)
		VALUES (#{siId}, #{riId}, #{spIdx}, #{spUrl})
	</insert>

</mapper>